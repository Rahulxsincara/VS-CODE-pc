<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced PDF Reader</title>
    <link rel="icon" type="image/x-icon" href="favicon/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* PDF Reader Specific Styles */
        .pdf-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: var(--shadow);
        }
        
        .pdf-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .pdf-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .reader-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .reader-container {
                grid-template-columns: 1fr;
            }
        }
        
        .viewer-section {
            padding: 20px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
        }
        
        .sidebar {
            padding: 20px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow-y: auto;
            max-height: 800px;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.02);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: rgba(0, 123, 255, 0.1);
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .nav-buttons, .zoom-buttons {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .nav-buttons button, .zoom-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .nav-buttons button:hover, .zoom-buttons button:hover {
            background: #0056b3;
        }
        
        .nav-buttons button:disabled {
            background: var(--secondary);
            cursor: not-allowed;
        }
        
        .page-info {
            margin: 0 15px;
            font-weight: 500;
        }
        
        .zoom-level {
            margin: 0 10px;
            min-width: 50px;
            text-align: center;
        }
        
        .pdf-canvas {
            width: 100%;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 0 auto;
            display: block;
        }
        
        .text-content {
            background: rgba(0, 0, 0, 0.02);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        
        .thumbnail {
            width: 60px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .thumbnail:hover, .thumbnail.active {
            opacity: 1;
            border-color: var(--primary);
        }
        
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: var(--accent3);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .hidden {
            display: none;
        }
        
        .sidebar h3 {
            color: var(--primary);
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .doc-info p {
            margin: 5px 0;
        }
        
        .sidebar-controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sidebar-controls button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: var(--primary);
            color: white;
            cursor: pointer;
            transition: background 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar-controls button:hover {
            background: #0056b3;
        }
        
        .back-button {
            display: inline-flex;
            align-items: center;
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            margin-bottom: 20px;
        }
        
        .back-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .back-button i {
            margin-right: 8px;
        }
        
        .error-message {
            color: #dc3545;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="theme-switcher">
        <button class="theme-btn" id="themeToggle">
            <i class="fas fa-palette"></i>
            <span>Themes</span>
        </button>
        <div class="theme-dropdown" id="themeDropdown">
            <button class="theme-option" data-theme="light">Light</button>
            <button class="theme-option" data-theme="dark">Dark</button>
            <button class="theme-option" data-theme="black">Black</button>
            <button class="theme-option" data-theme="modern-portfolio">Modern Portfolio</button>
        </div>
    </div>
    
    <!-- Favicon Button -->
    <div class="favicon-button">
        <a href="favicon/favicon.ico" download="favicon.ico" title="Download Favicon">
            <i class="fas fa-star"></i>
        </a>
    </div>

    <div class="pdf-container">
        <a href="index.html" class="back-button">
            <i class="fas fa-arrow-left"></i> Back to Library
        </a>
        
        <div class="pdf-header">
            <h1><i class="fas fa-file-pdf"></i> PDF Reader</h1>
            <p>Upload, view, and extract text from PDF files</p>
        </div>
        
        <div class="reader-container">
            <div class="viewer-section">
                <div class="upload-area" id="uploadArea">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Drop PDF file here or click to browse</h3>
                    <p>Supported format: .pdf</p>
                    <input type="file" id="pdfInput" accept=".pdf" class="hidden">
                </div>
                
                <div class="progress-bar">
                    <div class="progress" id="progressBar"></div>
                </div>
                
                <div class="controls">
                    <div class="nav-buttons">
                        <button id="prevPage" disabled><i class="fas fa-arrow-left"></i> Previous</button>
                        <span class="page-info" id="pageInfo">Page: 0 / 0</span>
                        <button id="nextPage" disabled>Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                    
                    <div class="zoom-buttons">
                        <button id="zoomOut"><i class="fas fa-search-minus"></i></button>
                        <span class="zoom-level" id="zoomLevel">150%</span>
                        <button id="zoomIn"><i class="fas fa-search-plus"></i></button>
                    </div>
                </div>
                
                <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
                
                <div class="thumbnail-container" id="thumbnailContainer"></div>
            </div>
            
            <div class="sidebar">
                <h3><i class="fas fa-info-circle"></i> Document Information</h3>
                <div class="doc-info" id="docInfo">
                    <p>No document loaded</p>
                </div>
                
                <h3><i class="fas fa-font"></i> Extracted Text</h3>
                <div class="text-content" id="textContent">
                    <p>Text will appear here after loading a PDF</p>
                </div>
                
                <div class="sidebar-controls">
                    <button id="downloadTextBtn"><i class="fas fa-download"></i> Download Text</button>
                    <button id="searchTextBtn"><i class="fas fa-search"></i> Search Text</button>
                    <button id="openLocalBtn"><i class="fas fa-folder-open"></i> Open Local PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // PDF.js configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let extractedText = '';

        // DOM Elements
        const elements = {
            pdfInput: document.getElementById('pdfInput'),
            uploadArea: document.getElementById('uploadArea'),
            pdfCanvas: document.getElementById('pdfCanvas'),
            prevPage: document.getElementById('prevPage'),
            nextPage: document.getElementById('nextPage'),
            pageInfo: document.getElementById('pageInfo'),
            zoomIn: document.getElementById('zoomIn'),
            zoomOut: document.getElementById('zoomOut'),
            zoomLevel: document.getElementById('zoomLevel'),
            docInfo: document.getElementById('docInfo'),
            textContent: document.getElementById('textContent'),
            thumbnailContainer: document.getElementById('thumbnailContainer'),
            progressBar: document.getElementById('progressBar'),
            downloadTextBtn: document.getElementById('downloadTextBtn'),
            searchTextBtn: document.getElementById('searchTextBtn'),
            openLocalBtn: document.getElementById('openLocalBtn')
        };

        // Theme switching functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeDropdown = document.getElementById('themeDropdown');
        const themeOptions = document.querySelectorAll('.theme-option');
        
        // Check for saved theme or default to light
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Toggle theme dropdown
        themeToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            themeDropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!themeToggle.contains(e.target) && !themeDropdown.contains(e.target)) {
                themeDropdown.classList.remove('active');
            }
        });
        
        // Apply selected theme
        themeOptions.forEach(option => {
            option.addEventListener('click', () => {
                const theme = option.getAttribute('data-theme');
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                themeDropdown.classList.remove('active');
            });
        });

        // Event listeners
        elements.uploadArea.addEventListener('click', () => elements.pdfInput.click());
        elements.pdfInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop support
        elements.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.add('dragover');
        });
        
        elements.uploadArea.addEventListener('dragleave', () => {
            elements.uploadArea.classList.remove('dragover');
        });
        
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                elements.pdfInput.files = e.dataTransfer.files;
                handleFileSelect();
            }
        });

        elements.prevPage.addEventListener('click', previousPage);
        elements.nextPage.addEventListener('click', nextPage);
        elements.zoomIn.addEventListener('click', zoomIn);
        elements.zoomOut.addEventListener('click', zoomOut);
        elements.downloadTextBtn.addEventListener('click', downloadText);
        elements.searchTextBtn.addEventListener('click', searchText);
        elements.openLocalBtn.addEventListener('click', openLocalPdf);

        // Function to open a local PDF file
        function openLocalPdf() {
            elements.pdfInput.click();
        }

        // Check for URL parameter to open a specific file
        function checkUrlForFile() {
            const urlParams = new URLSearchParams(window.location.search);
            const filePath = urlParams.get('file');
            
            if (filePath) {
                // Simulate file loading from the URL
                loadPdfFromPath(filePath);
            }
        }

        // Function to load PDF from a file path
        async function loadPdfFromPath(filePath) {
            try {
                elements.uploadArea.innerHTML = '<h3><i class="fas fa-spinner fa-spin"></i> Loading PDF...</h3>';
                updateProgress(30);
                
                // Fetch the PDF file
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`Failed to load PDF: ${response.status} ${response.statusText}`);
                }
                
                // Check if the response is actually a PDF
                const contentType = response.headers.get('content-type');
                if (contentType && !contentType.includes('application/pdf') && !contentType.includes('binary')) {
                    throw new Error('File is not a valid PDF document');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                
                // Check if the file is empty
                if (arrayBuffer.byteLength === 0) {
                    throw new Error('The PDF file is empty (0 bytes)');
                }
                
                updateProgress(60);
                
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                updateProgress(90);
                
                currentPage = 1;
                await renderPage(currentPage);
                await extractAllText();
                await generateThumbnails();
                
                // Extract file name from path
                const fileName = filePath.split('/').pop() || 'Unknown File';
                const fakeFile = {
                    name: fileName,
                    size: arrayBuffer.byteLength,
                    lastModified: Date.now()
                };
                
                updateDocumentInfo(fakeFile);
                updateProgress(100);
                
                setTimeout(() => {
                    elements.progressBar.style.width = '0%';
                }, 1000);
                
            } catch (error) {
                console.error('PDF Loading Error:', error);
                
                // Show error message in the UI
                elements.uploadArea.innerHTML = `
                    <div class="error-message">
                        <h3><i class="fas fa-exclamation-triangle"></i> Error Loading PDF</h3>
                        <p>${error.message}</p>
                        <p><strong>Solution:</strong> The file will be downloaded instead.</p>
                    </div>
                `;
                
                // Fallback to download the file directly after a delay
                setTimeout(() => {
                    if (confirm(`Error loading PDF: ${error.message}\n\nWould you like to download the file instead?`)) {
                        const link = document.createElement('a');
                        link.href = filePath;
                        link.download = filePath.split('/').pop() || 'document.pdf';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        resetUI();
                    }
                }, 2000);
            }
        }

        function updateProgress(percent) {
            elements.progressBar.style.width = percent + '%';
        }

        async function renderPage(pageNum) {
            if (!pdfDoc) return;

            const page = await pdfDoc.getPage(pageNum);
            const viewport = page.getViewport({ scale: scale });
            
            const canvas = elements.pdfCanvas;
            const context = canvas.getContext('2d');
            
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            const renderContext = {
                canvasContext: context,
                viewport: viewport
            };
            
            await page.render(renderContext).promise;
            
            // Update UI
            elements.pageInfo.textContent = `Page: ${pageNum} / ${pdfDoc.numPages}`;
            elements.prevPage.disabled = pageNum <= 1;
            elements.nextPage.disabled = pageNum >= pdfDoc.numPages;
            elements.zoomLevel.textContent = Math.round(scale * 100) + '%';
            
            // Update active thumbnail
            document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                thumb.classList.toggle('active', index + 1 === pageNum);
            });
        }

        async function extractAllText() {
            extractedText = '';
            elements.textContent.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Extracting text...</p>';
            
            try {
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    extractedText += pageText + '\n\n';
                }
                
                elements.textContent.innerHTML = `<pre>${extractedText.substring(0, 2000)}${extractedText.length > 2000 ? '...' : ''}</pre>`;
                if (extractedText.length > 2000) {
                    elements.textContent.innerHTML += `<p><em>Showing first 2000 characters. Full text has ${extractedText.length} characters.</em></p>`;
                }
            } catch (error) {
                elements.textContent.innerHTML = `<p>Error extracting text: ${error.message}</p>`;
            }
        }

        async function generateThumbnails() {
            elements.thumbnailContainer.innerHTML = '';
            
            for (let i = 1; i <= Math.min(pdfDoc.numPages, 20); i++) { // Limit to first 20 pages
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.2 });
                
                const canvas = document.createElement('canvas');
                canvas.className = 'thumbnail';
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                const context = canvas.getContext('2d');
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                await page.render(renderContext).promise;
                
                canvas.addEventListener('click', () => {
                    currentPage = i;
                    renderPage(currentPage);
                });
                
                elements.thumbnailContainer.appendChild(canvas);
            }
        }

        function updateDocumentInfo(file) {
            elements.docInfo.innerHTML = `
                <p><strong>File Name:</strong> ${file.name}</p>
                <p><strong>File Size:</strong> ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                <p><strong>Pages:</strong> ${pdfDoc ? pdfDoc.numPages : 'N/A'}</p>
                <p><strong>Last Modified:</strong> ${new Date(file.lastModified).toLocaleString()}</p>
            `;
        }

        function resetUI() {
            elements.uploadArea.innerHTML = `
                <h3><i class="fas fa-cloud-upload-alt"></i> Drop PDF file here or click to browse</h3>
                <p>Supported format: .pdf</p>
            `;
            elements.pageInfo.textContent = 'Page: 0 / 0';
            elements.prevPage.disabled = true;
            elements.nextPage.disabled = true;
            elements.zoomLevel.textContent = '150%';
            elements.docInfo.innerHTML = '<p>No document loaded</p>';
            elements.textContent.innerHTML = '<p>Text will appear here after loading a PDF</p>';
            elements.thumbnailContainer.innerHTML = '';
        }

        function previousPage() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPage(currentPage);
        }

        function nextPage() {
            if (currentPage >= (pdfDoc ? pdfDoc.numPages : 0)) return;
            currentPage++;
            renderPage(currentPage);
        }

        function zoomIn() {
            scale += 0.2;
            renderPage(currentPage);
        }

        function zoomOut() {
            if (scale <= 0.5) return;
            scale -= 0.2;
            renderPage(currentPage);
        }

        async function handleFileSelect() {
            const file = elements.pdfInput.files[0];
            if (!file) return;

            elements.uploadArea.innerHTML = '<h3><i class="fas fa-spinner fa-spin"></i> Loading PDF...</h3>';
            updateProgress(30);

            try {
                const arrayBuffer = await file.arrayBuffer();
                updateProgress(60);
                
                pdfDoc = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                updateProgress(90);
                
                currentPage = 1;
                await renderPage(currentPage);
                await extractAllText();
                await generateThumbnails();
                updateDocumentInfo(file);
                updateProgress(100);
                
                setTimeout(() => {
                    elements.progressBar.style.width = '0%';
                }, 1000);
                
            } catch (error) {
                alert('Error loading PDF: ' + error.message);
                resetUI();
            }
        }

        function downloadText() {
            if (!extractedText) {
                alert('No text to download. Please load a PDF first.');
                return;
            }
            
            const blob = new Blob([extractedText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extracted-text.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function searchText() {
            if (!extractedText) {
                alert('No text to search. Please load a PDF first.');
                return;
            }
            
            const searchTerm = prompt('Enter text to search:');
            if (!searchTerm) return;
            
            const matches = (extractedText.match(new RegExp(searchTerm, 'gi')) || []).length;
            alert(`Found ${matches} matches for "${searchTerm}"`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Check if there's a file to load from URL parameters
            checkUrlForFile();
        });
    </script>
</body>
</html>